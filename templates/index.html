<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repozytorium Pocztówek</title>
    <style>
        /* (Te same style co wcześniej - skrócone dla czytelności) */
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
        }

        body {
            font-family: sans-serif;
            background: var(--bg-color);
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header i Formularz */
        .search-box {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        input, select, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
        }

        /* Tabela */
        .table-wrapper {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        th {
            background: var(--primary-color);
            color: white;
        }

        /* Klikalny wiersz */
        tr.clickable-row {
            cursor: pointer;
            transition: background 0.1s;
        }

        tr.clickable-row:hover {
            background-color: #eaf2f8;
        }

        /* Miniatury */
        .thumb-img {
            width: 120px;
            height: 120px;
            object-fit: contain; /* Zachowuje proporcje w kwadracie 120x120 */
            background: #eee;
            border-radius: 4px;
            display: block;
        }

        /* Badge */
        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .badge-city {
            background: #e8f6f3;
            color: #1abc9c;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 style="text-align:center; color:#2c3e50;">Repozytorium Pocztówek</h1>
        <form id="searchForm" action="/" method="get" class="search-box">
            <input type="text" name="q" placeholder="Szukaj..." value="{{ search_query }}">
            <select id="wydawca_id" name="wydawca_id">
                <option value="0">-- Dowolny wydawca --</option>
            </select>
            <select id="miasto_id" name="miasto_id">
                <option value="0">-- Dowolne miasto --</option>
            </select>
            <select id="autor_id" name="autor_id">
                <option value="0">-- Dowolny fotograf --</option>
            </select>
            <button type="submit">Szukaj</button>
            <button type="button" id="resetBtn" style="background:#777;">Reset</button>
            <select id="sort" name="sort"></select>
        </form>
    </header>

        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th style="width: 60px;">Numer</th>
                    <th style="width: 140px;">Awers</th>
                    <th>Dane pocztówki</th>
                    <th></th>
                </tr>
                </thead>
                <tbody id="resultsBody">
                <!-- Tu wpadną dane z JS -->
                </tbody>
            </table>
            <!-- Spinner ładowania na dole -->
            <div id="loadingIndicator" style="text-align:center; padding: 20px; display: none; color: #777;">
                Ładowanie kolejnych elementów...
            </div>
        </div>
    </div>

    <script>
        let currentOffset = 0;
        let isLoading = false;
        let hasMore = true; // Czy są jeszcze dane do pobrania

        // 1. Pobieranie danych do Selectów
        async function loadFilters() {
            try {
            const response = await fetch('/api/filters');
            const data = await response.json();

            populateSelect('wydawca_id', data.wydawcy, 'wydawca_id', 'wydawca_nazwa');
            populateSelect('miasto_id', data.miasta, 'miasto_id', 'miasto_nazwa');
            populateSelect('autor_id', data.autorzy, 'autor_id', 'autor_nazwa');
            populateSelect('sort', data.sort, 'field_id', 'field_name');
        } catch (e) {
            console.error("Błąd ładowania filtrów", e);
        }
    }

    function populateSelect(elementId, items, idKey = 'id', labelKey = 'name') {
        const select = document.getElementById(elementId);
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item[idKey];
            option.textContent = item[labelKey];
            select.appendChild(option);
        });
    }

 // 2. Pobieranie listy pocztówek
        async function loadCards(reset = false) {
            if (isLoading || (!hasMore && !reset)) return;

            isLoading = true;
            const tbody = document.getElementById('resultsBody');
            const loadingIndicator = document.getElementById('loadingIndicator');

            loadingIndicator.style.display = 'block';

            if (reset) {
                currentOffset = 0;
                hasMore = true;
                tbody.innerHTML = '';
            }

            // Zbieramy dane z formularza
            const formData = new FormData(document.getElementById('searchForm'));
            const params = new URLSearchParams(formData);

            // Dodajemy offset
            params.set('offset', currentOffset);

            // Obsługa parametrów z URL (tylko przy pierwszym ładowaniu)
            if (reset) {
                 const urlParams = new URLSearchParams(window.location.search);
                 for (const key of ['q','wydawca_id','autor_id','miasto_id','sort']) {
                    const value = urlParams.get(key);
                    if (value && !params.get(key)) {
                        params.set(key, value);
                        // Wypełnij też formularz
                        const field = document.getElementsByName(key)[0];
                        if(field) field.value = value;
                    }
                }
            }

            try {
                const response = await fetch(`/api/search?${params.toString()}`);
                const cards = await response.json();

                if (cards.length === 0) {
                    hasMore = false;
                    if (reset) {
                         tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Brak wyników</td></tr>';
                    }
                } else {
                    currentOffset += cards.length; // Przesuwamy offset o tyle ile pobraliśmy

                    cards.forEach(p => {
                        const tr = document.createElement('tr');
                        tr.className = 'clickable-row';
                        // Otwieranie w tej samej karcie
                        tr.onclick = () => window.location = `/view/${p.wydanie_id}`;
                        // Jeśli chcesz otwierać w nowej karcie:
                        // tr.onclick = (e) => { if(!e.ctrlKey) window.location = `/view/${p.wydanie_id}`; };

                        const imgHtml = p.awers_id
                            ? `<img src="/images/${p.awers_id}_mini.jpg" class="thumb-img" alt="Miniatura">`
                            : `<div class="thumb-img" style="display:flex; align-items:center; justify-content:center; color:#999;">Brak</div>`;

                        const autorHtml = p.autor_nazwa ? `fot: ${p.autor_nazwa}` : `<span style="color:#7f8c8d;">fot: nieznany</span>`;
                        const yearHtml = (p.wydanie_rok == "0" || !p.wydanie_rok) ? `<span style="color:#7f8c8d;">nieznany</span>` : p.wydanie_rok;
                        const nakladHtml = p.wydanie_naklad ? `${p.wydanie_naklad}` : `<span style="color:#7f8c8d;">nieznany</span>`;

                        tr.innerHTML = `
                            <td>${p.wydawca_wzor_numer}</td>
                            <td>${imgHtml}</td>
                            <td>
                                <div style="font-weight:bold; color:#2c3e50;">${p.miasto_nazwa || "Nieznane miasto"}</div>
                                <div style="font-size:0.9em; color:#555;">${p.wzor_opis || "Brak opisu"}</div>
                                <div style="font-size:0.8em;">${autorHtml}</div>
                            </td>
                            <td>
                                <strong>${p.wydanie_numer}</strong><br>
                                <div style="font-size:0.85em; color:#7f8c8d;">rok: ${yearHtml}</div>
                                <div style="font-size:0.85em; color:#7f8c8d;">nakład: ${nakladHtml}</div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                // Aktualizacja URL bez przeładowania (tylko przy resecie)
                if (reset) {
                    // Usuwamy offset z URL żeby był czysty
                    params.delete('offset');
                    window.history.pushState({}, '', `?${params.toString()}`);
                }

            } catch (e) {
                console.error("Błąd ładowania kart", e);
                tbody.innerHTML += '<tr><td colspan="4" style="text-align:center; color:red;">Błąd pobierania danych</td></tr>';
            } finally {
                isLoading = false;
                loadingIndicator.style.display = 'none';
            }
        }

        // Obsługa Infinite Scroll
        function handleScroll() {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;

            // Jeśli jesteśmy 100px od dołu strony
            if (scrollTop + clientHeight >= scrollHeight - 100) {
                loadCards(false);
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadFilters();
            loadCards(true); // Pierwsze ładowanie (reset)
        });

        // Podpięcie scrolla
        window.addEventListener('scroll', handleScroll);

        document.getElementById('searchForm').addEventListener('submit', (e) => {
            e.preventDefault();
            loadCards(true); // Reset i nowe szukanie
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('searchForm').reset();
            loadCards(true);
        });

    </script>

</body>
</html>